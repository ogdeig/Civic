<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeffs Mail ‚Ä¢ Epstein Files | Civic Threat</title>

  <meta name="description" content="Jeffs Mail is a simulated email-style interface for navigating publicly released Epstein-related documents. Browse inbox-style entries and open attached source PDFs. Adults 21+ only." />
  <meta name="robots" content="index,follow" />

  <meta property="og:title" content="Jeffs Mail ‚Ä¢ Epstein Files | Civic Threat" />
  <meta property="og:description" content="A simulated email-style interface for navigating publicly released Epstein-related documents. Browse inbox-style entries and open attached source PDFs. Adults 21+ only." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://civicthreat.us/released/epstein/jeffs-mail" />
  <meta property="og:image" content="https://civicthreat.us/assets/civicthreat-social-1200x630.jpg" />

  <link rel="icon" href="/assets/logo.png" />
  <link rel="stylesheet" href="/styles.css" />

  <style>
    /* Keep your site vibe, but emulate an email client layout */
    .page-wrap{ max-width: 1240px; margin: 0 auto; padding: 16px 12px 42px; }
    .ep-box{ border-radius: 0 !important; }
    .panel{ border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); }

    /* App shell */
    .mail-shell{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      overflow: hidden;
    }

    .mail-topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
    }

    .brand-mini{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 220px;
    }
    .brand-mini .dot{
      width: 10px; height: 10px;
      background: var(--blue);
      display:inline-block;
      border-radius: 999px;
      box-shadow: 0 0 0 2px rgba(255,255,255,.08);
    }
    .brand-mini .title{
      font-weight: 1000;
      letter-spacing: .04em;
      font-size: 13px;
      line-height: 1.1;
      text-transform: uppercase;
    }
    .brand-mini .sub{
      font-size: 11px;
      opacity: .82;
      margin-top: 2px;
      line-height: 1.2;
      max-width: 360px;
    }

    .searchwrap{
      flex: 1 1 auto;
      display:flex;
      justify-content: center;
    }
    .search{
      width: min(760px, 100%);
      display:flex;
      gap: 8px;
      align-items:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      padding: 8px 10px;
    }
    .search input{
      width: 100%;
      border: 0;
      outline: 0;
      background: transparent;
      color: #fff;
      font-size: 13px;
    }
    .search .hint{ font-size: 11px; opacity:.75; white-space:nowrap; }

    .top-actions{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      min-width: 180px;
      flex-wrap: wrap;
    }
    .pill{
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.14);
      padding: 5px 10px;
      opacity: .92;
      background: rgba(0,0,0,.25);
      user-select:none;
    }
    .pill.good{ border-color: rgba(0,242,234,.35); }
    .pill.warn{ border-color: rgba(255,0,80,.35); }
    .pill a{ color:#fff; text-decoration: underline; }

    /* Layout columns */
    .mail-grid{
      display:grid;
      grid-template-columns: 240px 380px 1fr;
      min-height: min(74vh, 860px);
    }
    @media (max-width: 1100px){
      .mail-grid{ grid-template-columns: 220px 360px 1fr; }
    }
    @media (max-width: 980px){
      .mail-grid{ grid-template-columns: 220px 1fr; }
      .reader{ display:none; }
      .reader.open{ display:block; grid-column: 1 / -1; border-left: 0 !important; border-top: 1px solid rgba(255,255,255,.10); }
      .listcol{ border-left: 1px solid rgba(255,255,255,.10); }
    }
    @media (max-width: 720px){
      .mail-grid{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .listcol{ border-left: 0; }
      .reader{ display:none; }
      .reader.open{
        display:block;
        grid-column: 1 / -1;
        position: fixed;
        inset: 56px 10px 10px 10px;
        z-index: 9997;
        box-shadow: 0 20px 60px rgba(0,0,0,.6);
      }
      .reader.open .reader-top{ position: sticky; top: 0; z-index: 2; }
    }

    /* Sidebar */
    .sidebar{
      border-right: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 10px;
    }
    .compose{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 10px 12px;
      font-weight: 900;
      letter-spacing:.02em;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:#fff;
      cursor: default;
      user-select:none;
    }
    .compose .lock{ opacity:.9; }

    .navlist{ margin-top: 10px; display:flex; flex-direction:column; gap: 6px; }
    .navbtn{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
    }
    .navbtn:hover{ background: rgba(0,0,0,.28); }
    .navbtn.active{ outline: 1px solid rgba(0,242,234,.35); outline-offset: -1px; background: rgba(255,255,255,.05); }
    .navbtn .left{ display:flex; align-items:center; gap: 8px; min-width:0; }
    .navbtn .ico{ width: 18px; height: 18px; opacity:.9; flex:0 0 auto; }
    .navbtn .label{
      font-size: 12px; font-weight: 900; letter-spacing:.02em;
      overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .navbtn .count{ font-size: 11px; opacity:.85; flex:0 0 auto; }

    .side-note{
      margin-top: 10px;
      font-size: 11px;
      opacity: .80;
      line-height: 1.45;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
    }

    /* Message list */
    .listcol{
      border-right: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      display:flex;
      flex-direction: column;
      min-width: 0;
    }
    .list-top{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(0,0,0,.22);
    }
    .list-top .title{
      font-weight: 1000;
      letter-spacing:.02em;
      font-size: 13px;
      text-transform: uppercase;
    }
    .list-top .meta{
      font-size: 11px;
      opacity:.82;
      white-space: nowrap;
    }
    .list{
      overflow:auto;
      height: 100%;
    }
    .row{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
      min-width: 0;
      background: rgba(0,0,0,.10);
    }
    .row:hover{ background: rgba(0,0,0,.22); }
    .row.active{
      background: rgba(255,255,255,.06);
      outline: 1px solid rgba(255,255,255,.14);
      outline-offset: -1px;
    }
    .star{
      width: 18px; height: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity: .85;
      flex:0 0 auto;
      user-select:none;
    }
    .row .mid{ flex: 1 1 auto; min-width: 0; }
    .row .from{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.01em;
      margin: 0 0 3px;
      overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .row .subj{
      font-size: 12px;
      margin: 0 0 4px;
      opacity: .95;
      overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .row .snip{
      font-size: 11px;
      opacity: .78;
      line-height: 1.35;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .row .date{
      font-size: 11px;
      opacity:.78;
      white-space: nowrap;
      flex:0 0 auto;
      margin-left: 8px;
    }

    /* Reader */
    .reader{
      background: rgba(0,0,0,.10);
      min-width: 0;
      display:flex;
      flex-direction: column;
    }
    .reader-top{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .reader-top .rt{
      font-weight: 1000;
      letter-spacing:.02em;
      font-size: 13px;
      text-transform: uppercase;
    }
    .reader-top .btn{ border-radius: 0 !important; }
    .reader-body{
      padding: 12px 12px 16px;
      overflow:auto;
      min-width: 0;
    }
    .email-card{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 12px;
    }
    .email-card h2{
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 1000;
      letter-spacing:.01em;
      line-height: 1.25;
    }
    .headers{
      display:grid;
      grid-template-columns: 70px 1fr;
      gap: 6px 10px;
      font-size: 12px;
      line-height: 1.35;
      opacity: .92;
      margin-bottom: 10px;
    }
    .headers .k{ opacity:.75; }
    .chips{
      margin: 6px 0 10px;
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .chip{
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      padding: 3px 8px;
      opacity: .9;
    }
    .body{
      font-size: 13px;
      line-height: 1.65;
      opacity: .95;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
      word-break: break-word;
    }
    .body a{ color:#fff; text-decoration: underline; }
    .attachments{
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
    }
    .attachments .ttl{
      font-weight: 1000;
      letter-spacing:.02em;
      font-size: 12px;
      margin: 0 0 8px;
      opacity: .95;
    }
    .att{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      margin-bottom: 8px;
    }
    .att .name{
      font-size: 12px;
      opacity:.95;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
      flex: 1 1 auto;
    }
    .att .open{
      flex:0 0 auto;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.14);
      padding: 6px 10px;
      text-decoration: none;
      color:#fff;
      background: rgba(0,0,0,.20);
      border-radius: 0 !important;
      white-space: nowrap;
    }

    .legal{
      margin-top: 12px;
      font-size: 12px;
      opacity: .82;
      line-height: 1.55;
    }

    /* 21+ gate */
    .gate{
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.78);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .gate .card{
      width: min(720px, 100%);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,10,10,.92);
      border-radius: 0;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
    }
    .gate h2{ margin: 0 0 10px; font-size: 22px; }
    .gate p{ margin: 0 0 10px; opacity: .9; line-height: 1.55; }
    .gate .row{ display:flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    .gate label{ display:flex; gap:10px; align-items:center; cursor:pointer; }
    .gate input[type="checkbox"]{ width: 18px; height: 18px; }
    .gate .actions{ display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 14px; }
    .gate .btn{ border-radius: 0 !important; }
    .gate .legal{ margin-top: 10px; font-size: 12px; opacity: .8; line-height: 1.45; }

    /* safety net: ensure footer matches header red */
    .site-footer{ background: var(--red) !important; color:#fff; }
    .site-footer a{ color:#fff; }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z03YK1FYXW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z03YK1FYXW');
  </script>
</head>

<body>
  <!-- Header injected by app.js -->
  <div id="siteHeader"></div>

  <main class="page-wrap">
    <div class="mail-shell ep-box">
      <!-- App-like topbar -->
      <div class="mail-topbar">
        <div class="brand-mini">
          <span class="dot" aria-hidden="true"></span>
          <div>
            <div class="title">Jeffs Mail</div>
            <div class="sub">Simulated mailbox UI for navigating publicly released documents (21+).</div>
          </div>
        </div>

        <div class="searchwrap">
          <div class="search ep-box" role="search" aria-label="Search mail">
            <span style="opacity:.8">üîé</span>
            <input id="q" type="search" placeholder="Search mail (subject, sender, keywords‚Ä¶)" autocomplete="off" />
            <span class="hint" id="resultHint"></span>
          </div>
        </div>

        <div class="top-actions">
          <div class="pill good" id="sourcePill" title="Data source for this page">Source: index.json</div>
          <div class="pill warn" id="inAppPill" style="display:none">
            Open in <a href="#" id="openExternal">Chrome/Safari</a>
          </div>
        </div>
      </div>

      <!-- 3-column email UI -->
      <div class="mail-grid">
        <!-- Sidebar -->
        <aside class="sidebar">
          <div class="compose ep-box" title="Compose disabled (simulation)">
            <span class="lock">üîí</span> Compose
          </div>

          <div class="navlist" role="navigation" aria-label="Mailboxes">
            <div class="navbtn ep-box active" data-box="inbox" role="button" tabindex="0" aria-label="Inbox">
              <div class="left">
                <span class="ico" aria-hidden="true">üì•</span>
                <span class="label">Inbox</span>
              </div>
              <span class="count" id="cInbox">0</span>
            </div>

            <div class="navbtn ep-box" data-box="sent" role="button" tabindex="0" aria-label="Sent">
              <div class="left">
                <span class="ico" aria-hidden="true">üì§</span>
                <span class="label">Sent</span>
              </div>
              <span class="count" id="cSent">0</span>
            </div>

            <div class="navbtn ep-box" data-box="starred" role="button" tabindex="0" aria-label="Starred">
              <div class="left">
                <span class="ico" aria-hidden="true">‚≠ê</span>
                <span class="label">Starred</span>
              </div>
              <span class="count" id="cStarred">0</span>
            </div>

            <div class="navbtn ep-box" data-box="attachments" role="button" tabindex="0" aria-label="Attachments">
              <div class="left">
                <span class="ico" aria-hidden="true">üìé</span>
                <span class="label">Attachments</span>
              </div>
              <span class="count" id="cAttach">0</span>
            </div>
          </div>

          <div class="side-note">
            <strong>What you‚Äôre looking at:</strong> a browsing UI that <em>looks like</em> an email account, but is only an
            <strong>organizational interface</strong> for public records. It does not claim to be a real private inbox or hacked content.
          </div>
        </aside>

        <!-- List column -->
        <section class="listcol" aria-label="Message list">
          <div class="list-top">
            <div class="title" id="listTitle">Inbox</div>
            <div class="meta" id="listMeta">Loading‚Ä¶</div>
          </div>
          <div class="list" id="list">
            <div style="padding:10px 12px;opacity:.85;font-size:13px;">Loading mail‚Ä¶</div>
          </div>
        </section>

        <!-- Reader column -->
        <section class="reader" id="reader" aria-label="Message reader" style="border-left: 1px solid rgba(255,255,255,.10);">
          <div class="reader-top">
            <div class="rt" id="readerTopTitle">Message</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <button class="btn" id="btnBack" type="button" style="display:none">‚Üê Back</button>
              <button class="btn" id="btnClose" type="button" style="display:none">‚úï Close</button>
            </div>
          </div>

          <div class="reader-body" id="readerBody">
            <div class="email-card ep-box">
              <h2>Select an email</h2>
              <div class="legal">
                Click a message on the left to open it here. Attachments appear inside the message and link to your source PDFs.
              </div>
            </div>

            <div class="legal">
              <strong>Disclosure:</strong> Jeffs Mail is a simulated email-style UI for navigating publicly released documents.
              Entries may contain allegations or explicit descriptions. Civic Threat does not endorse wrongdoing and does not make claims about guilt or innocence.
              Always consult the full source document and primary sources for context.
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="legal" style="margin-top:12px">
      <strong>SEO / discoverability:</strong> Jeffs Mail is part of the Civic Threat Epstein files hub. Browse Epstein documents, released PDFs,
      and related materials in an inbox-style interface. Search names and keywords, open attachments, and review public records for discussion and analysis.
    </div>
  </main>

  <!-- Footer injected by app.js -->
  <div id="siteFooter"></div>

  <!-- 21+ gate -->
  <div class="gate" id="ageGate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card ep-box">
      <h2 id="gateTitle">Adults 21+ Only</h2>
      <p>This section may contain sexually explicit descriptions. You must confirm you are twenty-one (21) or older to view and use Jeffs Mail.</p>
      <div class="row">
        <label for="gateCheck">
          <input id="gateCheck" type="checkbox" />
          <span>I confirm that I am 21 or older.</span>
        </label>
      </div>
      <div class="actions">
        <button class="btn" id="gateLeave" type="button">Leave</button>
        <button class="btn blue" id="gateEnter" type="button" disabled>Continue</button>
      </div>
      <div class="legal">
        By continuing, you agree you are 21+ and understand the content may be explicit.
      </div>
    </div>
  </div>

  <!-- Site header/footer injection -->
  <script src="/config.js?v=12"></script>
  <script src="/app.js?v=12"></script>

  <script>
    (function(){
      "use strict";

      /* ------------------------------------------------------------------
        Jeffs Mail
        - Gmail-like UI (simulation) that loads messages from a separate index.json
        - You control the content via JSON: mailboxes, subjects, bodies, attachments (PDFs)
        - No PDF reader buttons‚Äîattachments are links inside the message like email attachments.

        REQUIRED FILES YOU CREATE:
        1) /released/epstein/jeffs-mail.html   (this file)
        2) /released/epstein/jeffs-mail/index.json  (your new data source)
        3) Put PDFs wherever you want; JSON should point to them via "path".

        JSON SCHEMA (example):
        {
          "account": { "name":"Jeffs Mail", "address":"jeffsmail@civicthreat.us" },
          "items":[
            {
              "id":"msg-0001",
              "mailbox":"inbox",              // inbox | sent | starred | attachments
              "starred": true,                // optional
              "date":"2019-07-10",             // ISO date recommended
              "from": { "name":"Public Record Release", "email":"source@public-records" },
              "to":   { "name":"Jeff", "email":"jeff@jeffs-mail" },
              "subject":"Example subject line",
              "snippet":"Short preview text for the list row‚Ä¶",
              "bodyText":"Full message text‚Ä¶ (plain text)\nLine breaks ok.",
              "bodyHtml":"<p>Optional HTML body</p>",   // optional; if present, used instead of bodyText
              "tags":["Released","PDF"],        // optional
              "attachments":[
                { "name":"ANASTASIA DOE vs EPSTEIN (Filed 12-17-19).pdf", "path":"/released/epstein/jeffs-mail-pdfs/ANASTASIA%20DOE_vs_EPSTEIN_Filed%2012-17-19.pdf" }
              ]
            }
          ]
        }
      ------------------------------------------------------------------ */

      const CONSENT_KEY = "ct_epstein_21_gate_v1";

      // ‚úÖ Separate index.json just for Jeffs Mail:
      const INDEX_URL = "/released/epstein/jeffs-mail/index.json";

      const $ = (sel, root=document) => root.querySelector(sel);
      const esc = (s)=> String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));
      const toLower = (s)=> String(s||"").toLowerCase();

      const el = {
        q: $("#q"),
        hint: $("#resultHint"),

        sourcePill: $("#sourcePill"),
        inAppPill: $("#inAppPill"),
        openExternal: $("#openExternal"),

        navBtns: Array.from(document.querySelectorAll(".navbtn[data-box]")),
        listTitle: $("#listTitle"),
        listMeta: $("#listMeta"),
        list: $("#list"),

        reader: $("#reader"),
        readerTopTitle: $("#readerTopTitle"),
        readerBody: $("#readerBody"),
        btnBack: $("#btnBack"),
        btnClose: $("#btnClose"),

        cInbox: $("#cInbox"),
        cSent: $("#cSent"),
        cStarred: $("#cStarred"),
        cAttach: $("#cAttach"),

        gate: $("#ageGate"),
        gateCheck: $("#gateCheck"),
        gateEnter: $("#gateEnter"),
        gateLeave: $("#gateLeave")
      };

      const state = {
        data: null,
        items: [],
        mailbox: "inbox",
        query: "",
        filtered: [],
        activeId: "",
      };

      function hasConsent(){
        try{ return localStorage.getItem(CONSENT_KEY) === "yes"; }catch(_){ return false; }
      }
      function setConsent(){
        try{ localStorage.setItem(CONSENT_KEY, "yes"); }catch(_){}
      }
      function showGate(){
        if(!el.gate) return;
        el.gate.style.display = "flex";
        document.body.style.overflow = "hidden";
        if(el.gateCheck) el.gateCheck.checked = false;
        if(el.gateEnter) el.gateEnter.disabled = true;
      }
      function hideGate(){
        if(!el.gate) return;
        el.gate.style.display = "none";
        document.body.style.overflow = "";
      }
      function wireGate(onEnter){
        if(!el.gate || !el.gateCheck || !el.gateEnter || !el.gateLeave) return onEnter();

        el.gateCheck.addEventListener("change", () => {
          el.gateEnter.disabled = !el.gateCheck.checked;
        });

        el.gateLeave.addEventListener("click", () => {
          location.href = "/";
        });

        el.gateEnter.addEventListener("click", () => {
          if(!el.gateCheck.checked) return;
          setConsent();
          hideGate();
          onEnter();
        });

        if(hasConsent()){
          hideGate();
          onEnter();
        }else{
          showGate();
        }
      }

      async function fetchJsonStrict(url){
        const u = url + (url.includes("?") ? "&" : "?") + "_=" + Date.now();
        const r = await fetch(u, { cache: "no-store" });
        if(!r.ok) throw new Error(`Failed to load index.json (${r.status})`);
        return r.json();
      }

      function isFacebookInApp(){
        const ua = navigator.userAgent || "";
        // common FB/IG in-app markers
        return /FBAN|FBAV|Instagram|FB_IAB|FBSS|FBIOS|FB4A/i.test(ua);
      }

      function setupInAppWarning(){
        if(!el.inAppPill || !el.openExternal) return;

        if(isFacebookInApp()){
          el.inAppPill.style.display = "inline-block";
          el.openExternal.addEventListener("click", (e) => {
            e.preventDefault();
            // Best we can do: instruct + open same URL; many in-app browsers show "Open in browser" from menu
            alert("Tip: Tap the ‚Ä¢‚Ä¢‚Ä¢ menu in the Facebook/Instagram browser and choose ‚ÄúOpen in Chrome‚Äù / ‚ÄúOpen in Safari‚Äù for best results.");
            try { window.location.href = window.location.href; } catch(_) {}
          });
        }
      }

      function parseDateLabel(s){
        const str = String(s||"").trim();
        if(!str) return "";
        // If ISO date, format nicely; otherwise show raw
        const d = new Date(str);
        if(String(d) !== "Invalid Date"){
          return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
        }
        return str;
      }

      function mailboxLabel(box){
        if(box === "sent") return "Sent";
        if(box === "starred") return "Starred";
        if(box === "attachments") return "Attachments";
        return "Inbox";
      }

      function setNavActive(){
        el.navBtns.forEach(b => {
          const on = (b.getAttribute("data-box") || "") === state.mailbox;
          b.classList.toggle("active", on);
        });
      }

      function computeCounts(items){
        const inbox = items.filter(x => (x.mailbox||"inbox") === "inbox").length;
        const sent = items.filter(x => (x.mailbox||"") === "sent").length;
        const starred = items.filter(x => x.starred === true || (x.mailbox||"") === "starred").length;
        const attach = items.filter(x => Array.isArray(x.attachments) && x.attachments.length).length;

        if(el.cInbox) el.cInbox.textContent = String(inbox);
        if(el.cSent) el.cSent.textContent = String(sent);
        if(el.cStarred) el.cStarred.textContent = String(starred);
        if(el.cAttach) el.cAttach.textContent = String(attach);
      }

      function normalizeItems(data){
        const raw = Array.isArray(data?.items) ? data.items : [];
        const out = [];

        for(const m of raw){
          const id = String(m.id || m._id || m.subject || "").trim() || ("msg-" + Math.random().toString(16).slice(2));
          const mailbox = String(m.mailbox || "inbox").toLowerCase();
          const from = m.from && typeof m.from === "object" ? m.from : { name: m.fromName || "Unknown", email: m.fromEmail || "" };
          const to = m.to && typeof m.to === "object" ? m.to : { name: m.toName || "Jeff", email: m.toEmail || "" };
          const subject = String(m.subject || "Untitled").trim();
          const snippet = String(m.snippet || "").trim();
          const date = m.date || m.sentAt || m.receivedAt || "";
          const starred = !!m.starred;
          const tags = Array.isArray(m.tags) ? m.tags : [];
          const bodyHtml = m.bodyHtml || "";
          const bodyText = m.bodyText || "";

          let attachments = [];
          if(Array.isArray(m.attachments)){
            attachments = m.attachments
              .map(a => {
                const name = String(a.name || a.label || a.file || "Attachment").trim();
                const path = String(a.path || a.url || "").trim();
                return (path ? { name, path } : null);
              })
              .filter(Boolean);
          }

          // If "attachments" mailbox view is selected, we still show messages; attachments are within messages.
          out.push({ id, mailbox, from, to, subject, snippet, date, starred, tags, bodyHtml, bodyText, attachments });
        }

        // newest first (if dates parse)
        out.sort((a,b) => {
          const da = new Date(a.date || 0).getTime();
          const db = new Date(b.date || 0).getTime();
          if(isFinite(da) && isFinite(db) && da !== db) return db - da;
          return String(b.id).localeCompare(String(a.id));
        });

        return out;
      }

      function applyFilter(){
        const q = toLower(state.query || "").trim();
        const box = state.mailbox;

        let list = state.items;

        if(box === "starred"){
          list = list.filter(x => x.starred === true || x.mailbox === "starred");
        }else if(box === "attachments"){
          list = list.filter(x => Array.isArray(x.attachments) && x.attachments.length);
        }else{
          list = list.filter(x => (x.mailbox || "inbox") === box);
        }

        if(q){
          list = list.filter(x => {
            const hay = toLower([
              x.subject, x.snippet,
              x.from?.name, x.from?.email,
              x.to?.name, x.to?.email,
              (x.tags||[]).join(" "),
              (x.bodyText||"")
            ].join(" "));
            return hay.includes(q);
          });
        }

        state.filtered = list;

        const total = list.length;
        if(el.hint) el.hint.textContent = total ? `${total} found` : "";
        if(el.listMeta) el.listMeta.textContent = total ? `${total} messages` : "No messages";
        if(el.listTitle) el.listTitle.textContent = mailboxLabel(box);

        renderList();
        // keep selection if possible
        if(state.activeId){
          const still = state.filtered.find(x => x.id === state.activeId);
          if(still) renderMessage(still);
          else clearReader();
        }else{
          clearReader();
        }
      }

      function renderList(){
        if(!el.list) return;

        if(!state.filtered.length){
          el.list.innerHTML = `<div style="padding:10px 12px;opacity:.85;font-size:13px;line-height:1.5;">
            No messages found for <strong>${esc(mailboxLabel(state.mailbox))}</strong>.
            ${state.query ? `Try clearing your search.` : `Check your index.json content.`}
          </div>`;
          return;
        }

        el.list.innerHTML = "";
        state.filtered.forEach(msg => {
          const row = document.createElement("div");
          row.className = "row ep-box" + (msg.id === state.activeId ? " active" : "");
          row.setAttribute("role","button");
          row.setAttribute("tabindex","0");
          row.setAttribute("aria-label", "Open email: " + (msg.subject || "message"));

          const star = msg.starred ? "‚≠ê" : "‚òÜ";
          const fromName = (msg.from && (msg.from.name || msg.from.email)) ? (msg.from.name || msg.from.email) : "Unknown";
          const subj = msg.subject || "(No subject)";
          const snip = msg.snippet || msg.bodyText || "";
          const date = parseDateLabel(msg.date);

          row.innerHTML = `
            <div class="star" title="${msg.starred ? "Starred" : "Not starred"}">${star}</div>
            <div class="mid">
              <div class="from">${esc(fromName)}</div>
              <div class="subj">${esc(subj)}</div>
              <div class="snip">${esc(String(snip).slice(0, 220))}</div>
            </div>
            <div class="date">${esc(date)}</div>
          `;

          row.addEventListener("click", () => openMessage(msg.id));
          row.addEventListener("keydown", (e) => {
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              openMessage(msg.id);
            }
          });

          el.list.appendChild(row);
        });
      }

      function setListActive(){
        if(!el.list) return;
        el.list.querySelectorAll(".row").forEach(r => r.classList.remove("active"));
        const idx = state.filtered.findIndex(x => x.id === state.activeId);
        if(idx >= 0){
          const row = el.list.children[idx];
          if(row) row.classList.add("active");
        }
      }

      function openMessage(id){
        const msg = state.filtered.find(x => x.id === id);
        if(!msg) return;
        state.activeId = msg.id;
        setListActive();
        renderMessage(msg);

        // Mobile: open reader overlay
        if(el.reader){
          if(window.matchMedia && window.matchMedia("(max-width: 980px)").matches){
            el.reader.classList.add("open");
            if(el.btnClose) el.btnClose.style.display = "inline-flex";
            if(el.btnBack) el.btnBack.style.display = "none";
          }
          if(window.matchMedia && window.matchMedia("(max-width: 720px)").matches){
            if(el.btnClose) el.btnClose.style.display = "inline-flex";
          }
        }
      }

      function clearReader(){
        state.activeId = "";
        if(el.readerTopTitle) el.readerTopTitle.textContent = "Message";
        if(el.readerBody){
          el.readerBody.innerHTML = `
            <div class="email-card ep-box">
              <h2>Select an email</h2>
              <div class="legal">
                Click a message in <strong>${esc(mailboxLabel(state.mailbox))}</strong> to open it here.
              </div>
            </div>

            <div class="legal">
              <strong>Disclosure:</strong> Jeffs Mail is a simulated email-style UI for navigating publicly released documents.
              It does not claim to show a real private inbox, hacked data, or private correspondence.
              Entries may contain allegations or explicit descriptions. Civic Threat does not endorse wrongdoing and does not make claims about guilt or innocence.
            </div>
          `;
        }
      }

      function renderMessage(msg){
        if(!msg || !el.readerBody) return;

        const fromName = msg.from?.name || "Unknown";
        const fromEmail = msg.from?.email || "";
        const toName = msg.to?.name || "Jeff";
        const toEmail = msg.to?.email || "";
        const subject = msg.subject || "(No subject)";
        const date = parseDateLabel(msg.date);

        const tags = Array.isArray(msg.tags) ? msg.tags : [];
        const tagHtml = tags.length ? `<div class="chips">${tags.map(t => `<span class="chip">${esc(t)}</span>`).join("")}</div>` : "";

        const bodyHtml = String(msg.bodyHtml || "").trim();
        const bodyText = String(msg.bodyText || "").trim();
        const body = bodyHtml
          ? bodyHtml
          : (bodyText ? `<div>${esc(bodyText).replace(/\n/g, "<br>")}</div>` : `<div style="opacity:.85">(No message body provided.)</div>`);

        const att = Array.isArray(msg.attachments) ? msg.attachments : [];
        const attHtml = att.length ? `
          <div class="attachments">
            <div class="ttl">Attachments</div>
            ${att.map(a => {
              const href = String(a.path || "").trim();
              const nm = String(a.name || "Attachment").trim();
              return `
                <div class="att ep-box">
                  <div class="name">üìé ${esc(nm)}</div>
                  <a class="open" href="${esc(href)}" target="_blank" rel="noopener">Open</a>
                </div>
              `;
            }).join("")}
            <div class="legal" style="margin-top:8px">
              Attachments open the original source PDFs in a new tab. If you‚Äôre in a Facebook/Instagram in-app browser, use ‚ÄúOpen in browser‚Äù for best results.
            </div>
          </div>
        ` : "";

        if(el.readerTopTitle) el.readerTopTitle.textContent = "Reading";

        el.readerBody.innerHTML = `
          <div class="email-card ep-box">
            <h2>${esc(subject)}</h2>

            ${tagHtml}

            <div class="headers">
              <div class="k">From</div>
              <div>${esc(fromName)}${fromEmail ? ` &lt;${esc(fromEmail)}&gt;` : ""}</div>

              <div class="k">To</div>
              <div>${esc(toName)}${toEmail ? ` &lt;${esc(toEmail)}&gt;` : ""}</div>

              <div class="k">Date</div>
              <div>${esc(date || "‚Äî")}</div>

              <div class="k">Mailbox</div>
              <div>${esc(mailboxLabel(state.mailbox))}${msg.starred ? " ‚Ä¢ Starred" : ""}</div>
            </div>

            <div class="body">${body}</div>

            ${attHtml}

            <div class="legal">
              <strong>Safety & context:</strong> This interface is an <em>organizational simulation</em>.
              It does not claim the message is an authentic private email. Treat entries as navigation cards tied to public sources.
              Allegations in documents should be read in context.
            </div>
          </div>
        `;
      }

      function wireNav(){
        el.navBtns.forEach(btn => {
          btn.addEventListener("click", () => {
            const box = btn.getAttribute("data-box") || "inbox";
            state.mailbox = box;
            setNavActive();
            clearReader();
            applyFilter();
          });
          btn.addEventListener("keydown", (e) => {
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              btn.click();
            }
          });
        });
      }

      function wireSearch(){
        if(!el.q) return;
        el.q.addEventListener("input", () => {
          state.query = el.q.value || "";
          applyFilter();
        });
      }

      function wireReaderClose(){
        if(!el.btnClose || !el.reader) return;

        function close(){
          el.reader.classList.remove("open");
        }

        el.btnClose.addEventListener("click", close);

        // Close overlay when ESC on small screens
        document.addEventListener("keydown", (e) => {
          if(e.key === "Escape" && el.reader.classList.contains("open")){
            close();
          }
        });
      }

      function renderSourcePill(){
        if(!el.sourcePill) return;
        el.sourcePill.textContent = "Source: jeffs-mail/index.json";
        el.sourcePill.title = INDEX_URL;
      }

      async function boot(){
        renderSourcePill();
        setupInAppWarning();
        wireNav();
        wireSearch();
        wireReaderClose();

        // Load JSON
        try{
          if(el.listMeta) el.listMeta.textContent = "Loading‚Ä¶";
          const data = await fetchJsonStrict(INDEX_URL);
          state.data = data;
          state.items = normalizeItems(data);
          computeCounts(state.items);
          setNavActive();
          applyFilter();
        }catch(err){
          console.error(err);
          if(el.listMeta) el.listMeta.textContent = "Offline";
          if(el.list){
            el.list.innerHTML = `<div style="padding:10px 12px;opacity:.9;font-size:13px;line-height:1.5;">
              Could not load <strong>${esc(INDEX_URL)}</strong>.<br>
              Make sure the file exists and is publicly accessible.<br>
              <span style="opacity:.8">Error: ${esc(err && err.message ? err.message : String(err))}</span>
            </div>`;
          }
          clearReader();
        }
      }

      document.addEventListener("DOMContentLoaded", () => wireGate(boot));
    })();
  </script>
</body>
</html>
