<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Released Files ‚Ä¢ Epstein Files | Civic Threat</title>
  <meta name="description" content="Listen to released court PDFs with text-to-speech, page-by-page controls, and a built-in viewer. For adults 21+ only." />
  <meta name="robots" content="index,follow" />
  <meta property="og:title" content="Epstein Files ‚Ä¢ Civic Threat" />
  <meta property="og:description" content="Listen to released court PDFs with page-by-page TTS and a built-in viewer. Adults 21+ only." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://civicthreat.us/released/epstein/epstein-reader.html" />
  <meta property="og:image" content="https://civicthreat.us/assets/civicthreat-social-1200x630.jpg" />
  <link rel="icon" href="/assets/logo.png" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .page-wrap{ max-width: 1120px; margin: 0 auto; padding: 22px 16px 42px; }
    .hero{ padding: 18px 0 10px; }
    .hero h1{ margin: 0 0 6px; font-size: clamp(26px, 4vw, 38px); letter-spacing:.02em; }
    .hero p{ margin: 0; opacity: .9; line-height: 1.5; }

    /* Square containers (match rest of site) */
    .ep-box{ border-radius: 0 !important; }
    .ep-grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap: 16px; margin-top: 16px; }
    @media (max-width: 980px){ .ep-grid{ grid-template-columns: 1fr; } }

    .ep-panel{ border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); }
    .ep-panel .pad{ padding: 14px; }

    .ep-label{ font-size: 12px; opacity: .85; margin: 0 0 6px; }
    .ep-row{ display:flex; gap:12px; flex-wrap: wrap; align-items: end; }
    .ep-row > .field{ flex: 1 1 240px; min-width: 220px; }
    .ep-row > .field.small{ flex: 0 0 180px; min-width: 160px; }

    select{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      color: #fff;
      outline: none;
      border-radius: 0;
    }

    .ep-controls{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
    .ep-controls .btn{ border-radius: 0 !important; }

    .ep-status{
      margin-top: 12px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      border-radius: 0;
      min-height: 54px;
    }
    .ep-status strong{ display:block; margin-bottom: 4px; }
    .ep-status .big{ font-size: 16px; font-weight: 900; letter-spacing:.02em; }

    .viewer-wrap{ display:flex; flex-direction: column; gap: 10px; }
    .viewer-top{ display:flex; justify-content: space-between; align-items: center; gap: 10px; }
    .viewer-top .meta{ font-size: 12px; opacity: .85; }
    .viewer-canvas{
      width: 100%;
      background: #000;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 0;
      min-height: 420px;
      display:block;
    }

    /* Photos under disclosure */
    .ep-photos{
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 700px){
      .ep-photos{ grid-template-columns: 1fr; }
    }
    .ep-photos figure{
      margin: 0;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
    }
    .ep-photos img{
      width: 100%;
      height: auto;
      display: block;
      border-radius: 0;
    }
    .ep-photos figcaption{
      padding: 8px 10px;
      font-size: 12px;
      opacity: .82;
      line-height: 1.35;
    }

    /* Autoplay/loop tiny helper */
    .ep-minihelp{
      margin-top: 8px;
      font-size: 12px;
      opacity: .78;
      line-height: 1.4;
    }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      margin-right: 6px;
      margin-bottom: 6px;
    }

    /* Viewer pop-out modal */
    .viewer-modal{
      position: fixed;
      inset: 0;
      z-index: 9998;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.82);
      padding: 18px;
    }
    .viewer-modal.open{ display:flex; }
    .viewer-modal .card{
      width: min(1080px, 96vw);
      max-height: 92vh;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,10,10,.94);
      border-radius: 0;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      display:flex;
      flex-direction: column;
    }
    .viewer-modal .head{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .viewer-modal .head strong{ letter-spacing:.02em; }
    .viewer-modal .body{
      padding: 12px;
      overflow: auto;
    }
    .viewer-modal canvas{
      width: 100%;
      height: auto;
      display:block;
      background:#000;
      border: 1px solid rgba(255,255,255,.12);
    }

    /* 21+ gate */
    .gate{
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.78);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .gate .card{
      width: min(720px, 100%);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,10,10,.92);
      border-radius: 0;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
    }
    .gate h2{ margin: 0 0 10px; font-size: 22px; }
    .gate p{ margin: 0 0 10px; opacity: .9; line-height: 1.55; }
    .gate .row{ display:flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    .gate label{ display:flex; gap:10px; align-items:center; cursor:pointer; }
    .gate input[type="checkbox"]{ width: 18px; height: 18px; }
    .gate .actions{ display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 14px; }
    .gate .btn{ border-radius: 0 !important; }
    .legal{ margin-top: 10px; font-size: 12px; opacity: .8; line-height: 1.45; }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z03YK1FYXW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z03YK1FYXW');
  </script>
</head>

<body>
  <!-- Site header (root-relative links to avoid subfolder 404s) -->
  <div id="siteHeader">
    <div class="topbar">
      <div class="wrap">
        <div class="inner">
          <div class="brandblock">
            <a class="brand" href="/index.html" aria-label="Home">
              <img src="/assets/logo.png" alt="Civic Threat logo"/>
              <div class="text">
                <strong>CIVIC THREAT</strong>
                <span>Debate &amp; Discuss</span>
              </div>
            </a>

            <div class="socialblock" aria-label="Follow Civic Threat on social media">
              <div class="followcta" aria-hidden="true">
                <span class="followtext">Follow us</span>
                <span class="followarrow">‚ûú</span>
              </div>
              <div class="iconrow" aria-label="Social links">
                <a class="iconbtn" href="https://www.facebook.com/CivicThreat/" target="_blank" rel="noopener" aria-label="Facebook">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12a10 10 0 1 0-11.6 9.9v-7H8v-2.9h2.4V9.8c0-2.4 1.4-3.7 3.6-3.7 1 0 2 .2 2 .2v2.2h-1.1c-1.1 0-1.5.7-1.5 1.4v1.7H16l-.4 2.9h-2.2v7A10 10 0 0 0 22 12z"/></svg>
                </a>
                <a class="iconbtn" href="https://www.youtube.com/@civicthreat" target="_blank" rel="noopener" aria-label="YouTube">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21.6 7.2a3 3 0 0 0-2.1-2.1C17.7 4.6 12 4.6 12 4.6s-5.7 0-7.5.5A3 3 0 0 0 2.4 7.2 31.7 31.7 0 0 0 2 12a31.7 31.7 0 0 0 .4 4.8 3 3 0 0 0 2.1 2.1c1.8.5 7.5.5 7.5.5s5.7 0 7.5-.5a3 3 0 0 0 2.1-2.1A31.7 31.7 0 0 0 22 12a31.7 31.7 0 0 0-.4-4.8zM10 15.5v-7l6 3.5-6 3.5z"/></svg>
                </a>
                <a class="iconbtn" href="https://www.tiktok.com/@civicthreat" target="_blank" rel="noopener" aria-label="TikTok">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16.6 3c.5 2.7 2.3 4.8 5 5.2v3.2c-1.9 0-3.6-.6-5-1.7v6.2c0 3.1-2.5 5.6-5.6 5.6S5.4 19 5.4 15.9s2.5-5.6 5.6-5.6c.5 0 1 .1 1.4.2v3.2c-.4-.2-.9-.3-1.4-.3-1.3 0-2.3 1-2.3 2.3s1 2.3 2.3 2.3 2.3-1 2.3-2.3V3h3.3z"/></svg>
                </a>
                <a class="iconbtn" href="https://x.com/CivicThreat" target="_blank" rel="noopener" aria-label="X">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.9 2H22l-6.9 7.9L23 22h-6.6l-5.2-6.7L5.4 22H2.3l7.4-8.5L1 2h6.8l4.7 6.1L18.9 2zm-1.1 18h1.7L6.1 3.9H4.3L17.8 20z"/></svg>
                </a>
              </div>
            </div>
          </div>

          <div class="nav">
            <div class="dropdown" id="platformsDD">
              <button class="btn" type="button" aria-haspopup="true" aria-expanded="false">Platforms ‚ñæ</button>
              <div class="dropdown-menu" role="menu" aria-label="Platforms menu">
                <div class="dd-title">Facebook</div>
                <a class="dd-item" role="menuitem" href="/facebook.html"><span>Support</span><small>Browse</small></a>
                <a class="dd-item" role="menuitem" href="/facebook-maga.html"><span>MAGA / Debate</span><small>Browse</small></a>
              </div>
            </div>

            <div class="dropdown" id="releasedDD">
              <button class="btn" type="button" aria-haspopup="true" aria-expanded="false">Released Files ‚ñæ</button>
              <div class="dropdown-menu" role="menu" aria-label="Released Files menu">
                <a class="dd-item" role="menuitem" href="/released/epstein/epstein-reader.html"><span>Epstein Files</span><small>PDF Reader (TTS)</small></a>
              </div>
            </div>

            <a class="btn blue" href="/submit.html">Submit</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="page-wrap">
    <header class="hero">
      <h1>Released Files ‚Ä¢ Epstein Files</h1>
      <p>Pick a PDF, choose a voice and speed, then press Play. Use Prev/Next to move one page at a time.</p>
    </header>

    <section class="ep-grid">
      <div class="ep-panel ep-box">
        <div class="pad">
          <div class="ep-row">
            <div class="field">
              <div class="ep-label">Choose a PDF</div>
              <select id="pdfSelect" aria-label="Choose a PDF">
                <option value="">Loading PDFs‚Ä¶</option>
              </select>
            </div>
            <div class="field">
              <div class="ep-label">Voice</div>
              <select id="voiceSelect" aria-label="Choose a voice">
                <option value="">Loading voices‚Ä¶</option>
              </select>
            </div>
            <div class="field small">
              <div class="ep-label">Speed</div>
              <select id="speedSelect" aria-label="Choose reading speed">
                <option value="1">1.0√ó</option>
                <option value="1.25">1.25√ó</option>
                <option value="1.5">1.5√ó</option>
                <option value="2">2.0√ó</option>
              </select>
            </div>
          </div>

          <div class="ep-controls" role="group" aria-label="Playback controls">
            <button class="btn blue" id="btnPlay" type="button">‚ñ∂ Play</button>
            <button class="btn" id="btnPause" type="button">‚è∏ Pause</button>
            <button class="btn" id="btnStop" type="button">‚èπ Stop</button>
            <button class="btn" id="btnPrev" type="button">‚Üê Prev Page</button>
            <button class="btn" id="btnNext" type="button">Next Page ‚Üí</button>
            <button class="btn" id="btnMute" type="button">üîá Mute</button>

            <!-- NEW -->
            <button class="btn" id="btnAutoRead" type="button" aria-pressed="false" title="Automatically advance to the next PDF when finished">‚è≠ Auto-Read: Off</button>
            <button class="btn" id="btnLoop" type="button" aria-pressed="false" title="Loops current PDF (unless Auto-Read is on, then loops all PDFs)">üîÅ Loop: Off</button>
          </div>

          <div class="ep-minihelp" id="autoHelp">
            <span class="pill"><strong>Auto-Read</strong> ON</span> will move to the next PDF automatically when one finishes.
            <br>
            <span class="pill"><strong>Loop</strong> ON</span> + Auto-Read ON = loop all PDFs. Loop ON alone = loop the same PDF.
          </div>

          <div class="ep-status ep-box" id="statusBox" aria-live="polite">
            <strong class="big" id="statusTitle">Ready.</strong>
            <div id="statusLine">Select a PDF to begin.</div>
          </div>

          <div class="legal">
            <strong>Disclosure:</strong> This page provides text-to-speech playback of publicly released documents. Content may contain sexually explicit material and is intended for adults.
            Civic Threat does not endorse wrongdoing; this tool is for reading and accessibility only.
          </div>

          <!-- Images directly below the disclosure -->
          <div class="ep-photos" aria-label="Related photos">
            <figure class="ep-box">
              <img
                src="/assets/epstein/trumpepstein.jpg"
                alt="Group photo at an event."
                loading="lazy"
                decoding="async"
              />
              <figcaption>Reference photo (public context).</figcaption>
            </figure>

            <figure class="ep-box">
              <img
                src="/assets/epstein/epstein-hero.jpg"
                alt="Courtroom scene photo."
                loading="lazy"
                decoding="async"
              />
              <figcaption>Courtroom context photo.</figcaption>
            </figure>
          </div>

        </div>
      </div>

      <div class="ep-panel ep-box">
        <div class="pad viewer-wrap">
          <div class="viewer-top">
            <div><strong>Viewer</strong></div>
            <div style="display:flex; gap:10px; align-items:center;">
              <div class="meta" id="pageMeta">No PDF loaded.</div>
              <!-- NEW -->
              <button class="btn" id="btnPopViewer" type="button" title="Pop out a larger viewer">üîç Pop-out</button>
            </div>
          </div>
          <canvas id="pdfCanvas" class="viewer-canvas" width="1000" height="1400"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- Viewer pop-out modal -->
  <div class="viewer-modal" id="viewerModal" role="dialog" aria-modal="true" aria-label="Pop-out PDF viewer">
    <div class="card ep-box">
      <div class="head">
        <div>
          <strong>PDF Viewer</strong>
          <span class="meta" id="viewerModalMeta" style="margin-left:10px; opacity:.85; font-size:12px;"></span>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn" id="btnViewerClose" type="button">‚úï Close</button>
        </div>
      </div>
      <div class="body">
        <canvas id="pdfCanvasBig" width="1600" height="2200"></canvas>
      </div>
    </div>
  </div>

  <div id="siteFooter">
    <footer class="site-footer">
      <div class="wrap">
        <div class="inner">
          <div>
            <div class="footer-brand">
              <img src="/assets/logo.png" alt="Civic Threat logo"/>
              <div class="t">
                <strong>CIVIC THREAT</strong>
                <span>Debate &amp; Discuss</span>
              </div>
            </div>
            <div class="footer-copy">¬© 2026 Civic Threat. All rights reserved.</div>
            <div class="footer-links" style="margin-top:10px">
              <a href="/about.html">About</a>
              <a href="/advertising-disclosure.html">Advertising Disclosure</a>
              <a href="/privacy.html">Privacy</a>
              <a href="/terms.html">Terms</a>
              <a href="/cookies.html">Cookies</a>
              <a href="/contact.html">Contact</a>
            </div>
          </div>
          <div></div>
        </div>
      </div>
    </footer>
  </div>

  <!-- 21+ gate -->
  <div class="gate" id="ageGate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card ep-box">
      <h2 id="gateTitle">Adults 21+ Only</h2>
      <p>This section may contain sexually explicit descriptions. You must confirm you are twenty-one (21) or older to view and use the reader.</p>
      <div class="row">
        <label for="gateCheck">
          <input id="gateCheck" type="checkbox" />
          <span>I confirm that I am 21 or older.</span>
        </label>
      </div>
      <div class="actions">
        <button class="btn" id="gateLeave" type="button">Leave</button>
        <button class="btn blue" id="gateEnter" type="button" disabled>Continue</button>
      </div>
      <div class="legal">
        By continuing, you agree you are 21+ and understand the content may be explicit.
      </div>
    </div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js" crossorigin="anonymous"></script>
  <script>
    if(window.pdfjsLib){
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }
    (function(){
      function qs(sel, root=document){ return root.querySelector(sel); }
      function qsa(sel, root=document){ return root ? Array.from(root.querySelectorAll(sel)) : []; }
      function wireDropdown(dd){
        if(!dd) return;
        const btn = qs("button", dd);
        const menu = qs(".dropdown-menu", dd);
        if(!btn || !menu) return;
        function close(){ dd.classList.remove("open"); btn.setAttribute("aria-expanded","false"); }
        function open(){ dd.classList.add("open"); btn.setAttribute("aria-expanded","true"); }
        btn.addEventListener("click",(e)=>{ e.preventDefault(); dd.classList.contains("open") ? close() : open(); });
        document.addEventListener("click",(e)=>{ if(!dd.contains(e.target)) close(); });
        document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); });
        qsa("a", menu).forEach(a=>a.addEventListener("click", close));
      }
      wireDropdown(qs("#platformsDD"));
      wireDropdown(qs("#releasedDD"));
    })();
  </script>

  <script src="./epstein-tts.js?v=14"></script>

  <!-- NEW: Autoplay/Loop + Pop-out viewer logic (no changes to epstein-tts.js needed) -->
  <script>
    (function(){
      function qs(sel, root=document){ return root.querySelector(sel); }
      function safeClick(btn){ try{ btn && btn.click(); }catch(e){} }

      const pdfSelect = qs("#pdfSelect");
      const btnPlay = qs("#btnPlay");
      const btnStop = qs("#btnStop");

      const statusTitle = qs("#statusTitle");
      const statusLine  = qs("#statusLine");

      const btnAutoRead = qs("#btnAutoRead");
      const btnLoop     = qs("#btnLoop");

      const pageMeta = qs("#pageMeta");

      // Viewer popout
      const btnPopViewer = qs("#btnPopViewer");
      const viewerModal = qs("#viewerModal");
      const btnViewerClose = qs("#btnViewerClose");
      const viewerModalMeta = qs("#viewerModalMeta");
      const canvasSmall = qs("#pdfCanvas");
      const canvasBig = qs("#pdfCanvasBig");
      const bigCtx = canvasBig && canvasBig.getContext ? canvasBig.getContext("2d") : null;

      // Toggles (persist)
      const LS_AUTO = "ep_reader_autoRead";
      const LS_LOOP = "ep_reader_loop";

      let autoRead = localStorage.getItem(LS_AUTO) === "1";
      let loopOn   = localStorage.getItem(LS_LOOP) === "1";

      function setBtnState(btn, on, labelOn, labelOff){
        if(!btn) return;
        btn.setAttribute("aria-pressed", on ? "true" : "false");
        btn.textContent = on ? labelOn : labelOff;
      }
      function syncButtons(){
        setBtnState(btnAutoRead, autoRead, "‚è≠ Auto-Read: On", "‚è≠ Auto-Read: Off");
        setBtnState(btnLoop, loopOn, "üîÅ Loop: On", "üîÅ Loop: Off");
      }
      syncButtons();

      if(btnAutoRead){
        btnAutoRead.addEventListener("click", function(){
          autoRead = !autoRead;
          localStorage.setItem(LS_AUTO, autoRead ? "1" : "0");
          syncButtons();
        });
      }
      if(btnLoop){
        btnLoop.addEventListener("click", function(){
          loopOn = !loopOn;
          localStorage.setItem(LS_LOOP, loopOn ? "1" : "0");
          syncButtons();
        });
      }

      // --- Detect "finished" states by watching status text (works without touching epstein-tts.js) ---
      // Adjust keywords here if your epstein-tts.js uses different wording.
      const DONE_RE = /(finished|complete|completed|done|end of|no more pages|reached the end|final page)/i;

      let lastDoneAt = 0;
      function isDoneText(){
        const t = (statusTitle && statusTitle.textContent || "") + " " + (statusLine && statusLine.textContent || "");
        return DONE_RE.test(t);
      }

      function getPdfOptions(){
        if(!pdfSelect) return [];
        return Array.from(pdfSelect.options || []).filter(o => o && o.value);
      }

      function advanceToNextPdf(loopAll){
        const opts = getPdfOptions();
        if(!opts.length) return false;

        const cur = pdfSelect.value;
        let idx = opts.findIndex(o => o.value === cur);
        if(idx < 0) idx = 0;

        let nextIdx = idx + 1;
        if(nextIdx >= opts.length){
          if(loopAll){
            nextIdx = 0;
          }else{
            return false;
          }
        }

        // Switch PDF
        pdfSelect.value = opts[nextIdx].value;
        pdfSelect.dispatchEvent(new Event("change", { bubbles: true }));

        // Give PDF load a moment, then play
        setTimeout(function(){
          safeClick(btnPlay);
        }, 600);

        return true;
      }

      function restartSamePdf(){
        if(!pdfSelect) return;
        // Stop then "re-select" same PDF to reset state, then play.
        safeClick(btnStop);
        const v = pdfSelect.value;
        setTimeout(function(){
          pdfSelect.value = v;
          pdfSelect.dispatchEvent(new Event("change", { bubbles: true }));
          setTimeout(function(){ safeClick(btnPlay); }, 600);
        }, 250);
      }

      // Observe status changes
      function tick(){
        if(isDoneText()){
          const now = Date.now();
          // Debounce so we don't trigger multiple times for the same completion
          if(now - lastDoneAt > 2500){
            lastDoneAt = now;

            if(autoRead){
              // AutoRead ON: go next file; if loop ON too, loop all PDFs
              const ok = advanceToNextPdf(loopOn);
              if(!ok){
                // reached end and loop-all is OFF -> stop
                safeClick(btnStop);
              }
            }else if(loopOn){
              // Loop ON only: loop same file
              restartSamePdf();
            }
          }
        }
        setTimeout(tick, 700);
      }
      setTimeout(tick, 900);

      // --- Pop-out viewer ---
      function openViewer(){
        if(!viewerModal) return;
        viewerModal.classList.add("open");
        if(viewerModalMeta && pageMeta) viewerModalMeta.textContent = pageMeta.textContent || "";
        drawBigOnce();
      }
      function closeViewer(){
        if(!viewerModal) return;
        viewerModal.classList.remove("open");
      }
      function drawBigOnce(){
        if(!canvasSmall || !canvasBig || !bigCtx) return;
        try{
          bigCtx.clearRect(0,0,canvasBig.width, canvasBig.height);
          // Draw the small canvas into the big one (scaled)
          bigCtx.drawImage(canvasSmall, 0, 0, canvasBig.width, canvasBig.height);
        }catch(e){}
      }

      if(btnPopViewer){
        btnPopViewer.addEventListener("click", openViewer);
      }
      if(btnViewerClose){
        btnViewerClose.addEventListener("click", closeViewer);
      }
      if(viewerModal){
        viewerModal.addEventListener("click", function(e){
          if(e.target === viewerModal) closeViewer();
        });
        document.addEventListener("keydown", function(e){
          if(e.key === "Escape" && viewerModal.classList.contains("open")) closeViewer();
        });
      }

      // Keep big canvas updated while modal is open
      setInterval(function(){
        if(viewerModal && viewerModal.classList.contains("open")){
          if(viewerModalMeta && pageMeta) viewerModalMeta.textContent = pageMeta.textContent || "";
          drawBigOnce();
        }
      }, 500);

    })();
  </script>

  <script src="/app.js?v=2"></script>
</body>
</html>
