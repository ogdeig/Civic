<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Civic Threat — Admin</title>
  <meta name="robots" content="noindex,nofollow"/>

  <!-- Use absolute paths so /admin/ never breaks assets -->
  <link rel="stylesheet" href="/styles.css"/>
</head>

<body data-page="admin_custom">
  <!-- MUST be a DIV (app.js injects header here) -->
  <div id="siteHeader"></div>

  <main style="padding-top:18px; padding-bottom:28px">
    <section class="hero">
      <div class="wrap">
        <h1 style="margin:0 0 6px 0">Admin</h1>
        <p class="lead" style="margin:0; opacity:.9">
          Review submissions, approve them to publish, or delete approved posts.
        </p>
        <div class="smallnote" style="margin-top:10px">
          This page is intended to be protected by Cloudflare Access.
        </div>
      </div>
    </section>

    <section class="section" style="padding-top:14px">
      <div class="wrap">
        <div class="toolbar">
          <div>
            <h2 style="margin:0">Pending</h2>
            <p class="sub">Waiting for approval</p>
          </div>
        </div>

        <div id="pendingList" class="stack">
          <div class="more" style="margin-top:0">Loading pending…</div>
        </div>
      </div>
    </section>

    <section class="section" style="padding-top:14px">
      <div class="wrap">
        <div class="toolbar">
          <div>
            <h2 style="margin:0">Approved</h2>
            <p class="sub">Live on the site</p>
          </div>
        </div>

        <div id="approvedList" class="stack">
          <div class="more" style="margin-top:0">Loading approved…</div>
        </div>
      </div>
    </section>
  </main>

  <!-- MUST be a DIV (app.js injects footer here) -->
  <div id="siteFooter"></div>

  <!-- Script order matters -->
  <script src="/config.js"></script>
  <script src="/data-api.js"></script>
  <script src="/app.js"></script>

  <!-- Admin-only logic -->
  <script>
  (function(){
    "use strict";

    const qs = (sel, root=document) => root.querySelector(sel);
    const esc = (s) => String(s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

    function requireRemote(){
      const cfg = window.CT_CONFIG || {};
      if(!cfg.REMOTE_DB || cfg.REMOTE_DB.enabled !== true) {
        throw new Error("REMOTE_DB is disabled. Enable it in config.js.");
      }
      if(!cfg.REMOTE_DB.appsScriptUrl) {
        throw new Error("REMOTE_DB.appsScriptUrl is missing in config.js.");
      }
      // data-api.js should expose BOTH CT_REMOTE and CT_API
      const api = window.CT_REMOTE || window.CT_API;
      if(!api) {
        throw new Error("Remote API not found. Make sure /data-api.js loads before /app.js.");
      }
      return api;
    }

    function errorBox(msg){
      return `
        <div class="smallnote" style="padding:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25)">
          <strong style="display:block; margin-bottom:6px">Admin data loading error</strong>
          <div>${esc(msg)}</div>
          <div style="margin-top:10px; opacity:.85">
            Tip: Open DevTools → Console and confirm <code>CT_API</code> or <code>CT_REMOTE</code> exists.
          </div>
        </div>
      `;
    }

    function card(item, mode){
      const title = esc(item.title || "Untitled");
      const url = esc(item.postUrl || "");
      const isMaga = (String(item.category||"").toLowerCase() === "maga");
      const cat = isMaga ? "MAGA / Debate" : "Support";
      const by = esc((item.submitterName || "Anonymous").trim() || "Anonymous");
      const submittedAt = item.submittedAt ? new Date(Number(item.submittedAt)) : null;
      const approvedAt  = item.approvedAt ? new Date(Number(item.approvedAt)) : null;

      const meta = (mode === "pending")
        ? `Facebook • ${esc(cat)} • Submitted by ${by}${submittedAt ? " • " + esc(submittedAt.toLocaleString()) : ""}`
        : `Facebook • ${esc(cat)} • Approved${approvedAt ? " " + esc(approvedAt.toLocaleString()) : ""} • Submitted by ${by}`;

      const actions = (mode === "pending")
        ? `
          <button class="btn blue" data-approve="${esc(item.id)}" type="button">Approve</button>
          <button class="btn" data-reject="${esc(item.id)}" type="button">Reject</button>
        `
        : `
          <a class="btn blue" href="${url}" target="_blank" rel="noopener">Go to Post</a>
          <button class="btn danger" data-delete-approved="${esc(item.id)}" type="button">Delete</button>
        `;

      return `
        <article class="post-card" style="padding:14px; border-radius:0">
          <div style="display:flex; gap:14px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap">
            <div style="min-width:260px; flex:1">
              <div style="font-weight:900; font-size:16px">${title}</div>
              <div class="smallnote" style="margin-top:6px">${meta}</div>
              <div class="smallnote" style="margin-top:6px">
                <a href="${url}" target="_blank" rel="noopener">${url}</a>
              </div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              ${actions}
            </div>
          </div>
        </article>
      `;
    }

    async function load(){
      const pendingHost  = qs("#pendingList");
      const approvedHost = qs("#approvedList");

      try{
        const api = requireRemote();

        const pending = (await api.listPending()) || [];
        const approved = (await api.listApproved()) || [];

        const p = pending
          .filter(x => (x.platform || "facebook") === "facebook")
          .sort((a,b) => (Number(b.submittedAt)||0) - (Number(a.submittedAt)||0));

        const a = approved
          .filter(x => (x.platform || "facebook") === "facebook")
          .sort((x,y) => (Number(y.approvedAt)||0) - (Number(x.approvedAt)||0));

        pendingHost.innerHTML  = p.length ? p.map(x => card(x,"pending")).join("") : `<div class="smallnote">No pending submissions.</div>`;
        approvedHost.innerHTML = a.length ? a.map(x => card(x,"approved")).join("") : `<div class="smallnote">No approved posts yet.</div>`;
      }catch(err){
        console.error(err);
        const msg = (err && err.message) ? err.message : String(err);
        if(pendingHost) pendingHost.innerHTML = errorBox(msg);
        if(approvedHost) approvedHost.innerHTML = errorBox(msg);
      }
    }

    document.addEventListener("click", async (e)=>{
      const approveBtn = e.target.closest("[data-approve]");
      const rejectBtn  = e.target.closest("[data-reject]");
      const delBtn     = e.target.closest("[data-delete-approved]");

      try{
        const api = requireRemote();

        if(approveBtn){
          const id = approveBtn.getAttribute("data-approve");
          approveBtn.textContent = "Approving…";
          await api.approve(id);
          await load();
          return;
        }

        if(rejectBtn){
          const id = rejectBtn.getAttribute("data-reject");
          rejectBtn.textContent = "Rejecting…";
          await api.reject(id);
          await load();
          return;
        }

        if(delBtn){
          const id = delBtn.getAttribute("data-delete-approved");
          const ok = confirm("Delete this approved post? This cannot be undone.");
          if(!ok) return;
          delBtn.textContent = "Deleting…";
          await api.deleteApproved(id);
          await load();
          return;
        }
      }catch(err){
        console.error(err);
        alert("Action failed: " + ((err && err.message) ? err.message : String(err)));
      }
    });

    document.addEventListener("DOMContentLoaded", load);
  })();
  </script>
</body>
</html>
