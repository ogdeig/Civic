name: Build PDF index.json

on:
  push:
    branches: [ "main" ]
    paths:
      - "pdfs/**"
      - ".github/workflows/build-pdf-index.yml"

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate pdfs/index.json
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p pdfs

          # Collect PDFs (case-insensitive)
          mapfile -t files < <(find pdfs -maxdepth 1 -type f \( -iname "*.pdf" \) -printf "%f\n" | sort -f)

          # Write JSON
          out="pdfs/index.json"
          echo "[" > "$out"

          first=1
          for f in "${files[@]}"; do
            # Title = filename without extension, with separators prettified
            base="${f%.*}"
            title="${base//_/ }"
            title="${title//-/ }"

            # Escape double quotes for JSON safety (rare, but just in case)
            title="${title//\"/\\\"}"
            f_esc="${f//\"/\\\"}"

            if [ $first -eq 1 ]; then
              first=0
              printf '  { "file": "%s", "title": "%s" }\n' "$f_esc" "$title" >> "$out"
            else
              printf '  , { "file": "%s", "title": "%s" }\n' "$f_esc" "$title" >> "$out"
            fi
          done

          echo "]" >> "$out"

          echo "Generated $out with ${#files[@]} PDF(s)."

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet -- pdfs/index.json; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add pdfs/index.json
          git commit -m "Auto-update pdfs/index.json"
          git push
