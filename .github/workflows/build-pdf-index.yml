name: Build PDF index.json

on:
  push:
    branches: [ "main" ]
    paths:
      - "pdfs/**"
      - ".github/workflows/build-pdf-index.yml"

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Diagnostics (show repo + pdfs folder)
        shell: bash
        run: |
          set -euo pipefail
          echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Top-level files:"
          ls -la
          echo ""
          echo "pdfs folder contents:"
          if [ -d "pdfs" ]; then
            ls -la pdfs
          else
            echo "pdfs/ does not exist in this repo on this branch."
          fi

      - name: Generate pdfs/index.json
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p pdfs

          # Collect PDFs (case-insensitive), only in /pdfs (not subfolders)
          mapfile -t files < <(find pdfs -maxdepth 1 -type f -iname "*.pdf" -printf "%f\n" | sort -f)

          out="pdfs/index.json"
          echo "[" > "$out"

          first=1
          for f in "${files[@]}"; do
            base="${f%.*}"
            title="${base//_/ }"
            title="${title//-/ }"
            title="${title//\"/\\\"}"
            f_esc="${f//\"/\\\"}"

            if [ $first -eq 1 ]; then
              first=0
              printf '  { "file": "%s", "title": "%s" }\n' "$f_esc" "$title" >> "$out"
            else
              printf '  , { "file": "%s", "title": "%s" }\n' "$f_esc" "$title" >> "$out"
            fi
          done

          echo "]" >> "$out"

          echo ""
          echo "Generated $out with ${#files[@]} PDF(s)."
          echo "index.json preview:"
          cat "$out"

      - name: Commit changes (including new file)
        shell: bash
        run: |
          set -euo pipefail

          # Detect any change, including untracked index.json
          if [ -z "$(git status --porcelain pdfs/index.json)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add pdfs/index.json
          git commit -m "Auto-update pdfs/index.json"
          git push
